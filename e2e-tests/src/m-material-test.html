<m-light type="spotlight" intensity="900" ry="45" rx="65" rz="-45" x="17.5" y="15" z="10"></m-light>

<m-group id="cubes" data-loaded-materials="0"></m-group>

<m-group id="ui" y="10">
  <m-label
    id="addCube"
    x="-6"
    y="0"
    z="0"
    content="Create cube"
    width="2"
    alignment="center"
  ></m-label>
  <m-label
    id="removeCube"
    x="-3"
    y="0"
    z="0"
    content="Remove cube"
    width="2"
    alignment="center"
  ></m-label>
</m-group>

<script>
  const addCubeButton = document.getElementById("addCube");
  const removeCubeButton = document.getElementById("removeCube");
  const cubes = document.getElementById("cubes");
  const canvasWidth = 14;
  const cubeSize = 2;
  const gap = 0.5;

  const materials = {
    bricks: {
      map: "http://localhost:7079/assets/bricks/Bricks_512_Color.png",
      "ao-map": "http://localhost:7079/assets/bricks/Bricks_512_AmbientOcclusion.png",
      "normal-map": "http://localhost:7079/assets/bricks/Bricks_512_NormalGL.png",
      "roughness-map": "http://localhost:7079/assets/bricks/Bricks_512_Roughness.png",
    },
  };

  function createCube() {
    const cube = document.createElement("m-cube");
    const material = document.createElement("m-material");

    const limitPerRow = Math.floor(canvasWidth / (cubeSize + gap));
    const newCubeCount = cubes.children.length + 1;
    const cubeIndex = newCubeCount - 1;
    const curY = Math.floor(cubeIndex / limitPerRow) * (cubeSize + gap);
    const curX = (cubeIndex % limitPerRow) * (cubeSize + gap) - canvasWidth / 2 + cubeSize;

    cube.setAttribute("width", cubeSize.toString());
    cube.setAttribute("height", cubeSize.toString());
    cube.setAttribute("depth", cubeSize.toString());

    cube.setAttribute("x", curX);
    cube.setAttribute("y", curY);
    cube.appendChild(material);

    const nextTexture = Object.keys(materials)[cubeIndex % Object.keys(materials).length];
    Object.entries(materials[nextTexture]).forEach(([key, value]) => {
      material.setAttribute(key, value);
    });

    // Removes m-material child
    cube.addEventListener("click", (event) => {
      const materialChild = event.target.querySelector("m-material");
      if (materialChild) {
        event.target.removeChild(materialChild);
      }
    });

    cube.addEventListener("materialLoaded", (event) => {
      cubes.setAttribute(
        "data-loaded-materials",
        parseInt(cubes.getAttribute("data-loaded-materials")) + 1,
      );
    });
    cube.addEventListener("materialDisconnected", (event) => {
      cubes.setAttribute(
        "data-loaded-materials",
        parseInt(cubes.getAttribute("data-loaded-materials")) - 1,
      );
    });

    cubes.appendChild(cube);
    return cube;
  }

  function removeCube(element) {
    const toRemove = element ? element : cubes.lastElementChild;
    const hasChildMaterial = !!toRemove.querySelector("m-material");
    if (toRemove) {
      cubes.removeChild(toRemove);
    }
    if (hasChildMaterial) {
      // the disconnected event is not fired when removing the parent
      cubes.setAttribute(
        "data-loaded-materials",
        parseInt(cubes.getAttribute("data-loaded-materials")) - 1,
      );
    }
  }
  addCubeButton.addEventListener("click", (event) => createCube());
  removeCubeButton.addEventListener("click", (event) => removeCube());

  const animAttrs = ["x", "y", "z", "sx", "sy", "sz"];
  function createAnimElement(container) {
    const animElement = document.createElement("m-attr-anim");
    animElement.setAttribute("attr", animAttrs[Math.floor(Math.random() * animAttrs.length)]);
    animElement.setAttribute("start", "1");
    animElement.setAttribute("end", "2");
    animElement.setAttribute("start-time", "1000");
    animElement.setAttribute("duration", "500");
    animElement.setAttribute("ping-pong", "true");
    animElement.setAttribute("easing", "easeInOutCubic");
    container.appendChild(animElement);
  }
</script>
